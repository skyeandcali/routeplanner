<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>SchoolRun â€” Live Board</title>

<style>
  @font-face{font-family:"Uber Move";src:local("Uber Move"),local("UberMove-Regular");font-weight:400;font-style:normal;font-display:swap}
  @font-face{font-family:"Uber Move";src:local("Uber Move Bold"),local("UberMove-Bold");font-weight:700;font-style:normal;font-display:swap}
</style>

<style>
  :root{
    --bg:#000; --panel:#0a0a0a; --card:#111; --text:#fff; --muted:#a3a3a3;
    --border:#1f1f1f; --pill:#171717; --shadow:0 10px 20px rgba(0,0,0,.35);
    --good:#22c55e; --warn:#f59e0b;
    --chip-bg:#1a1a1a; --chip-text:#fff;
    --stop-badge:#d80f2f; --stop-text:#ffffff;
    --gutter:10px;
    --arrow:#a855f7;
    --tab-bg:#eef2f71c;
    --tab-bg-strong:#e5e7eb33;
    --toggle-track:#e5e7eb33;
    --toggle-knob:#fff;
    --toggle-icon:#111;
  }
  body.light{
    --bg:#fff; --panel:#ffffff; --card:#fff; --text:#111; --muted:#575757;
    --border:#e5e7eb; --pill:#f4f5f6; --shadow:0 8px 18px rgba(0,0,0,.12);
    --chip-bg:#f4f5f6; --chip-text:#111;
    --stop-badge:#d80f2f; --stop-text:#ffffff;
    --arrow:#7c3aed;
    --tab-bg:#eef2f7;
    --tab-bg-strong:#e4e9f1;
    --toggle-track:#e5e7eb;
    --toggle-knob:#111;
    --toggle-icon:#fff;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:"Uber Move",-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,"Helvetica Neue",Arial,Inter,system-ui,sans-serif;
    letter-spacing:.01em;
  }

  .wrap{width:100%; max-width:none; margin:0; padding:0 var(--gutter) 18px}

  .topbar{
    position:sticky; top:0; z-index:40;
    display:flex; align-items:center; justify-content:space-between;
    height:auto; padding:10px var(--gutter);
    background:var(--panel); border-bottom:1px solid var(--border);
    gap:10px;
  }
  .brand-stack{ display:flex; flex-direction:column; gap:8px; align-items:flex-start; }
  .brand-row{ display:flex; align-items:center; gap:10px; }
  .logo-img{
    height:100px; width:auto; display:block;
    background: transparent; /* ensure no background is applied */
  }
  .appname{font-weight:700;font-size:18px}

  .menu{ display:flex; gap:8px; }
  .tabbtn{
    width:46px; height:46px; display:grid; place-items:center;
    border-radius:12px; border:1px solid var(--border);
    background:var(--tab-bg); color:var(--arrow); cursor:pointer;
  }
  .tabbtn:hover{ background:var(--tab-bg-strong); }
  .tabbtn.active{ background:var(--tab-bg); border-color:var(--border); }
  .icon{ font-size:22px; line-height:1; user-select:none; display:inline-block; }
  @keyframes blinkIcon { 0%,49%{opacity:1} 50%,100%{opacity:.2} }
  .tabbtn.active .icon{ animation:blinkIcon 1s infinite }

  .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); overflow:visible; }
  .table-container{ padding:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; overscroll-behavior-x:contain; touch-action:pan-x; }
  table{ width:100%; min-width:880px; border-collapse:separate; border-spacing:0 6px; table-layout:fixed; }
  thead th{ font-size:11px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted); padding:10px 10px; text-align:left }
  tbody tr{ background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow) }
  tbody td{ padding:10px 10px; font-size:15px; vertical-align:top }
  tbody tr td:first-child{border-radius:12px 0 0 12px}
  tbody tr td:last-child{border-radius:0 12px 12px 0}
  .ell{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  .stopLetter{
    display:inline-flex;align-items:center;justify-content:center;
    width:28px;height:28px;border-radius:50%;
    background:var(--stop-badge); color:var(--stop-text);
    font-weight:800; line-height:1; border:none; box-shadow:0 2px 6px rgba(0,0,0,.28);
  }
  .chip{ display:inline-flex;align-items:center;justify-content:center; min-width:48px;height:28px;padding:0 10px;border-radius:8px;font-weight:800; background:var(--chip-bg); color:var(--chip-text); border:1px solid var(--border) }
  .arrive{ display:flex;flex-direction:column;gap:2px;align-items:flex-end; font-variant-numeric:tabular-nums; font-feature-settings:"tnum" 1 }
  .eta-line{ display:flex; gap:6px; white-space:nowrap } .eta-time{ font-weight:800 } .eta-veh{ opacity:.75 } .muted{ color:var(--muted) }

  .meta{ display:flex;justify-content:space-between;gap:8px; padding:10px 12px;color:var(--muted);border-top:1px solid var(--border);font-size:12px }

  .skeleton{height:14px;width:60px;border-radius:6px;background:linear-gradient(90deg,#1d1d1d,#2a2a2a,#1d1d1d);background-size:200% 100%;animation:shim 1.1s infinite}
  body.light .skeleton{background:linear-gradient(90deg,#e9e9e9,#f4f4f4,#e9e9e9)}
  @keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .toggle{
    position:relative; width:74px; height:34px; border-radius:999px; padding:4px;
    background:var(--toggle-track); border:1px solid var(--border);
    display:flex; align-items:center; cursor:pointer; user-select:none;
  }
  .toggle input{
    position:absolute; inset:0;
    opacity:0;
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    margin:0; border:0; outline:0;
    cursor:pointer;
  }
  .toggle input:focus-visible + .knob,
  .toggle:has(input:focus-visible){ box-shadow:0 0 0 3px rgba(99,102,241,.35) }
  .knob{
    width:26px; height:26px; border-radius:999px; background:var(--toggle-knob);
    display:grid; place-items:center; color:var(--toggle-icon);
    font-size:14px; font-weight:900; transform:translateX(0); transition:transform .2s ease;
    box-shadow:0 2px 6px rgba(0,0,0,.25); z-index:1;
  }
  .toggle input:checked ~ .knob{ transform:translateX(40px); }
  .mark{ position:absolute; top:50%; transform:translateY(-50%); font-size:12px; opacity:.9; z-index:0; }
  .mark.sun{ left:12px } .mark.moon{ right:12px }
</style>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#000000">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="icon" sizes="192x192" href="icons/icon-192.png">

</head>
<body>
  <header class="topbar">
    <div class="brand-stack">
      <div class="brand-row">
        <img class="logo-img" alt="SchoolRun"
             src="https://image2url.com/images/1759438318821-6f565a57-a09d-4576-b651-0003f9b18e8d.png">
        <div class="appname">SchoolRun</div>
      </div>
      <nav class="menu" id="menuTabs">
        <button class="tabbtn active" data-view="morning" aria-label="Morning">
          <span class="icon" aria-hidden="true">â–²</span>
        </button>
        <button class="tabbtn" data-view="afternoon" aria-label="Afternoon">
          <span class="icon" aria-hidden="true">â–¼</span>
        </button>
      </nav>
    </div>

    <div class="theme-ctl" aria-label="Theme">
      <label class="toggle" for="themeSwitch" title="Toggle theme (Light/Dark)" role="switch" aria-checked="false">
        <input id="themeSwitch" type="checkbox" aria-label="Theme switch"/>
        <span class="mark sun">â˜€ï¸Ž</span>
        <span class="mark moon">ðŸŒ™</span>
        <span class="knob" id="knob">ðŸŒ™</span>
      </label>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="table-container" id="viewBody"></div>
      <div class="meta">
        <div>Last updated: <span id="lastUpdated">never</span></div>
        <div>Auto-refresh 10s â€¢ TfL Unified API</div>
      </div>
    </section>
  </div>

<script>
(function(){
  const sw = document.getElementById('themeSwitch');
  const knob = document.getElementById('knob');
  const toggleLabel = document.querySelector('.toggle');
  const key = 'sr_theme';
  const setKnob = () => { knob.textContent = sw.checked ? 'â˜€ï¸Ž' : 'ðŸŒ™'; toggleLabel.setAttribute('aria-checked', String(sw.checked)); };

  const saved = localStorage.getItem(key);
  if(saved === 'light'){ document.body.classList.add('light'); sw.checked = true; }
  setKnob();

  sw.addEventListener('change', ()=>{
    document.body.classList.toggle('light', sw.checked);
    localStorage.setItem(key, sw.checked ? 'light' : 'dark');
    setKnob();
  });
})();

const APP_ID="", APP_KEY="";
const qs=o=>new URLSearchParams({...o,...((APP_ID&&APP_KEY)?{app_id:APP_ID,app_key:APP_KEY}:{})}).toString();
const tfl=async url=>{const r=await fetch(url); if(!r.ok) throw new Error('TfL'); return r.json();};
const arrivalsAt=(id,modes)=>tfl(`https://api.tfl.gov.uk/StopPoint/${encodeURIComponent(id)}/Arrivals?${qs({modes})}`);

function matchByLine(rows,line){
  const w=String(line).toUpperCase().trim();
  return rows.filter(r=>{
    const id=String(r.lineId||'').toUpperCase().trim();
    const nm=String(r.lineName||'').toUpperCase().trim();
    return id===w||nm===w||id.startsWith(w)||nm.startsWith(w);
  });
}
const minsUntil=ts=>Math.max(0,Math.round((new Date(ts)-new Date())/60000));
function rowLineHTML(timeStr, mins, vehicleId){
  const color = mins<=2 ? 'var(--good)' : (mins<=8 ? 'var(--warn)' : 'var(--text)');
  return `<div class="eta-line" style="color:${color}">
    <span class="eta-time">${timeStr}</span>
    <span>(${mins<=0 ? 'Due' : mins+'m'})</span>
    <span class="eta-veh">â€¢ ${vehicleId||'â€”'}</span>
  </div>`;
}
const etaCache = new Map();
function smooth(key,mins){
  if(mins==null) return null;
  const prev=etaCache.get(key);
  if(prev==null){etaCache.set(key,mins);return mins;}
  const maxJump=5;
  if(Math.abs(mins-prev)>maxJump) mins = prev + Math.sign(mins-prev)*maxJump;
  const a=0.6; const sm=Math.round(a*mins+(1-a)*prev);
  etaCache.set(key,sm); return sm;
}
const routesConfig={
  morning:[
    {line:"268", origin:"Haverstock Hill", destination:"Golders Green Bus Station", stopLetter:"H",  stopId:"490003874H"},
    {line:"268", origin:"Rosslyn Hill",     destination:"Golders Green Bus Station", stopLetter:"G",  stopId:"490015255G"},
    {line:"210", origin:"Brent Cross Tesco", destination:"Golders Green Bus Station", stopLetter:"T",  stopId:"490004284T"},
    {line:"102", origin:"Claremont Way",    destination:"Golders Green Bus Station", stopLetter:"A",  stopId:"490005434S"},
    {line:"SL10",origin:"Hendon Central Station", destination:"North Finchley Bus Station", stopLetter:"A",  stopId:"490000106A"},
    {line:"13",  origin:"Golders Green",    destination:"North Finchley Bus Station", stopLetter:"GU", stopId:"490015496GU"},
    {line:"460", origin:"Golders Green",    destination:"North Finchley Bus Station", stopLetter:"GU", stopId:"490015496GU"},
  ],
  afternoon:[
    {line:"460", origin:"North Finchley Bus Station", destination:"Golders Green Bus Station", stopLetter:"P",  stopId:"490015443P"},
    {line:"13",  origin:"North Finchley Bus Station", destination:"Golders Green Bus Station", stopLetter:"P",  stopId:"490015443P"},
    {line:"SL10",origin:"North Finchley Bus Station", destination:"Hendon Central", stopLetter:"H", stopId:"490010369H"},
    {line:"268", origin:"Golders Green", destination:"Pond Street / Royal Free", stopLetter:"GJ", stopId:"490000087GJ"},
    {line:"102", origin:"Golders Green Station", destination:"Claremont Way", stopLetter:"GV", stopId:"490015496GV"},
    {line:"210", origin:"Golders Green", destination:"Brent Cross Underground", stopLetter:"GK", stopId:"490000087GK"},
  ]
};

let currentView='morning';
const viewBody=document.getElementById('viewBody');

function renderBusTable(which){
  const rows=routesConfig[which];
  const colgroup = `
    <colgroup>
      <col style="width:64px"><col style="width:28%"><col style="width:28%"><col style="width:10%"><col>
    </colgroup>`;
  const head=`<thead><tr>
    <th>Board</th><th>Origin</th><th>Destination</th><th>Line</th>
    <th style="text-align:right">Arrivals (next 3)</th>
  </tr></thead>`;
  const body=rows.map((r,i)=>`
    <tr>
      <td><span class="stopLetter" title="${r.stopLetter}">${r.stopLetter}</span></td>
      <td class="ell" title="${r.origin}">${r.origin}</td>
      <td class="ell" title="${r.destination}">${r.destination}</td>
      <td><span class="chip">${r.line}</span></td>
      <td style="text-align:right"><div class="arrive" id="bus-${which}-${i}">
        <span class="skeleton"></span></div>
      </td>
    </tr>`).join('');
  return `<table>${colgroup}${head}<tbody>${body}</tbody></table>`;
}

async function updateBus(which){
  const rows=routesConfig[which];
  await Promise.all(rows.map(async (r,i)=>{
    const etaEl=document.getElementById(`bus-${which}-${i}`);
    try{
      const data=await arrivalsAt(r.stopId,'bus');
      const match=matchByLine(data,r.line).sort((a,b)=>new Date(a.expectedArrival)-new Date(b.expectedArrival));
      if(!match.length){ etaEl.textContent='â€”'; etaEl.classList.add('muted'); return; }
      const html = match.slice(0,3).map((m,idx)=>{
        let mins = minsUntil(m.expectedArrival);
        if(idx===0) mins = smooth(`${which}:${i}`, mins);
        const timeStr = new Date(Date.now()+Math.max(0,mins)*60000)
                          .toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        return rowLineHTML(timeStr, mins, m.vehicleId);
      }).join('');
      etaEl.innerHTML = html;
    }catch{ etaEl.textContent='â€”'; etaEl.classList.add('muted'); }
  }));
  lastUpdated.textContent=new Date().toLocaleTimeString();
}

async function render(){
  viewBody.innerHTML = renderBusTable(currentView);
}

async function refresh(){
  await updateBus(currentView);
  lastUpdated.textContent=new Date().toLocaleTimeString();
}

render(); refresh();
setInterval(refresh, 10000);

document.querySelectorAll('#menuTabs .tabbtn').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    document.querySelectorAll('#menuTabs .tabbtn').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    currentView = btn.dataset.view;
    await render();
    await refresh();
  });
});
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js', { scope: './' });
  });
}
</script>

</body>
</html>
